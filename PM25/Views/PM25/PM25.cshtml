@{
    ViewBag.Title = "PM25";
}
<h2>PM25</h2>

<head>
    <style type="text/css">
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
        }

        #map {
            height: 100%;
        }

        #map_wrapper {
            height: 50px;
        }

        #map_canvas {
            width: 100%;
            height: 100%;
        }
    </style>
</head>


<div id="map">
</div>

<!--The jQuery library is required and is referenced by default in _Layout.cshtml. -->
<script src="~/Scripts/jquery-1.6.4.min.js"></script>
<!--Reference the SignalR library. -->
<script src="~/Scripts/jquery.signalR-2.2.0.js"></script>
<!--Reference the autogenerated SignalR hub script. -->
<script src="~/signalr/hubs"></script>

<script type="text/javascript" src="http://maps.google.com/maps/api/js" type="text/javascript"></script>
<script src="~/Scripts/markerclusterer.js"></script>
<script type="text/javascript">
    $(function () {

        var markers = [];
        var infowindow = null;

        // Create our info window content
        var infoWindowContent = '';



        // Reference the auto-generated proxy for the hub.
        var chat = $.connection.pM25Hub;
        // Create a function that the hub can call back to display messages.
        var mapValues = [];
        chat.client.getPM25Json = function (d) {

            $.each(d, function (index) {

                marker = new google.maps.Marker({
                    position: new google.maps.LatLng(d[index].TWD97Lat, d[index].TWD97Lon),
                    map: map,
                    icon: "../../Content/" + d[index].PM25icon
                });

                infoWindow = new google.maps.InfoWindow({
                    content: ""
                });


                google.maps.event.addListener(marker, 'mouseover', (function (marker) {
                    return function () {

                        infoWindowContent = '<div id="map_wrapper">' +
                                            '<div id="map_canvas" class="mapping">' +
                                            '<div>測站: ' + d[index].SiteName + '</div>' +
                                            '<div>地址: ' + d[index].SiteAddress + '</div>' +
                                            '<div>PM2.5: ' + d[index].PM25 + ' µg/m³</div>' +
                                            '</div>' +
                                            '</div>'


                        infoWindow.setContent(infoWindowContent);
                        infoWindow.open(map, marker);
                    }
                })(marker));


                google.maps.event.addListener(marker, 'mouseout', (function (marker) {
                    return function () {
                        infoWindow.close();
                    }
                })(marker));


                markers.push(marker);
            });
            var markerCluster = new MarkerClusterer(map, markers);

        };

        // map options
        var options = {
            zoom: 8,
            center: new google.maps.LatLng(23.69781, 120.96051499999999),
            mapTypeId: google.maps.MapTypeId.ROADMAP,
            mapTypeControl: false
        };

     

        // init map
        var map = new google.maps.Map(document.getElementById('map'), options);



        //$("#test").gmap3({
        //    clear: {
        //        name: ["marker"]
        //    },
        //    marker: {
        //        values: mapValues,
        //        tag: "mmm"
        //    }
        //});


        // Start the connection.
        $.connection.hub.start().done(function () {

            // Call the getAllData method on the hub.
            chat.server.getAllData();

        });
    });



</script>






